<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      --primary: #000000;
      --secondary: #46a0fa;
      --price: #d22c27;
      --buttons: #46a0fa;
      --accent: #FFD166;
      --background: #F7FFF7;
      --text: #2b2c2d;
      --card-bg: #FFFFFF;
      --border-radius: 12px;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }

    body {
      background: var(--background);
      color: var(--text);
      font-weight: 500;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
    }

    header {
      display: flex;
      justify-content: center;
      background: var(--primary);
      color: white;
      padding: 16px 20px;
      text-align: center;
      font-size: 2.5rem;
      font-weight: 700;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
    }

    main {
      padding: 16px;
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
      flex: 1;
    }

    /* Stats Bar */
    .stats {
      display: flex;
      gap: 12px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }
    .stat-box {
      flex: 1 1 200px;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 14px 16px;
      font-weight: 700;
      color: var(--primary);
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
      font-size: 1rem;
      min-width: 180px;
    }
    .stat-box:hover { background: #fff5f5; }
    .stat-box.active { background: #28a745; color: white; }

    /* Filter */
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
      align-items: center;
    }
    .filter-bar label { font-weight: 600; font-size: 0.95rem; margin-right: 6px; }
    .filter-bar select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: white;
      font-size: 0.9rem;
      flex: 0 1 180px;
      outline: none;
      transition: var(--transition);
    }
    .filter-bar select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(210,44,39,0.12); }

    #orderCount {
      margin-bottom: 16px;
      font-weight: 600;
      color: var(--text);
      text-align: center;
    }

    /* Orders */
    .orders-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }
    .order {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: transform 0.2s ease;
    }
    .order:hover { transform: translateY(-3px); }
    .order strong { color: #d22c27; }
    s { color:#8c8c8c; }

    /* Toast */
    #toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 10px 18px;
      border-radius: 20px;
      font-size: 0.9rem;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 1000;
    }
    #toast.show { opacity: 1; }

    .logout-container {
      position: fixed;
      top: 10px;
      right: 10px;
    }
    #logoutBtn {
      background: #d22c27;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: background 0.3s;
    }
    #logoutBtn:hover { background: #a71d2a; }
      .footer {
  background: #f9f9f9;
  color: #000000;
  text-align: center;
  padding: 10px 16px;
  font-size: 0.97rem;
  font-weight: 450;
  border-top: 1px solid #ddd;
}
.footer a {
  color: #292929;
  font-weight: 600;
  text-decoration: none;
}
.footer a:hover { text-decoration: underline; }

    .admin-nav {
      background: var(--primary, #03045e);
      color: white;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      top: 0;
      z-index: 100;
    }
    .nav-container {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
    }
    .nav-logo { font-weight: 700; font-size: 1.1rem; }
    .nav-links {
      list-style: none;
      display: flex;
      gap: 18px;
    }
    .nav-links a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      padding: 6px 10px;
      border-radius: 6px;
      transition: background 0.2s;
    }
    .nav-links a:hover { background: rgba(255, 255, 255, 0.15); }
    .nav-links a.active { color: #FF6400; font-weight: 700; }

    /* Mobile */
    .nav-toggle {
      display: none;
      font-size: 1.4rem;
      background: none;
      border: none;
      color: white;
      cursor: pointer;
    }
    @media (max-width: 768px) {
      .nav-links {
        position: absolute;
        top: 56px;
        right: 0;
        background: var(--primary, #03045e);
        flex-direction: column;
        width: 200px;
        padding: 10px;
        display: none;
      }
      .nav-links.show { display: flex; }
      .nav-toggle { display: block; }
    }
  </style>

</head>
<body>
  <script type="module" src="auth-guard.js"></script>
  <header>Admin Dashboard 
    <div class="logout-container">
      <button id="logoutBtn">Logout</button>
    </div>
  </header>
  <nav class="admin-nav">
    <div class="nav-container">
      <div class="nav-logo">Sanseoul</div>
      <button class="nav-toggle" id="navToggle">☰</button>
      <ul class="nav-links" id="navLinks">
        <li><a href="admin-dashboard.html">Dashboard</a></li>
        <li><a href="analytics.html">Analytics</a></li>
        <li><a href="stock-manager.html">Stock Manager</a></li>
        <li><a href="index.html">Order panel</a></li>
      </ul>
    </div>
  </nav>

  <main>
    <!-- Sales Stats -->
    <div class="stats">
      <div class="stat-box" id="todaySales">Today's Sales: ₹0</div>
      <div class="stat-box" id="monthSales">This Month's Sales: ₹0</div>
      <div class="stat-box" id="totalSales">Total Sales: ₹0</div>
      <div class="stat-box" id="distributorPay">Sanseoul Payment (Month): ₹0</div>
      <div class="stat-box" id="balanceBox">Balance: ₹0</div>
    </div>

    <!-- Filter -->
    <div class="filter-bar">
      <label for="filter">Filter Orders:</label>
      <select id="filter">
        <option value="all">All</option>
        <option value="today">Today</option>
        <option value="month">This Month</option>
        <option value="completed">Completed</option>
        <option value="pending">Pending</option>
      </select>
    </div>

    <!-- Order Count -->
    <div id="orderCount">Showing 0 orders</div>

    <!-- Orders -->
    <div id="orders" class="orders-grid"></div>
  </main>

  <div id="toast"></div>

  <script type="module">
  import { db, auth } from "./firebase-config.js";
  import { 
    collection, query, orderBy, onSnapshot, 
    doc, setDoc, updateDoc, increment, getDoc, serverTimestamp 
  } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import { signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

  const ordersDiv = document.getElementById("orders");
  const filterSelect = document.getElementById("filter");
  const todaySalesEl = document.getElementById("todaySales");
  const monthSalesEl = document.getElementById("monthSales");
  const totalSalesEl = document.getElementById("totalSales");
  const distributorPayEl = document.getElementById("distributorPay");
  const balanceBoxEl = document.getElementById("balanceBox");
  const orderCountEl = document.getElementById("orderCount");

  let unsubscribeOrders = null;

  function highlightStatBox(box) {
    document.querySelectorAll(".stat-box").forEach(el => el.classList.remove("active"));
    if (box) box.classList.add("active");
  }

  function loadOrders() {
    const filterValue = filterSelect.value;
    const todayDate = new Date().toISOString().split("T")[0];
    const currentMonth = todayDate.slice(0, 7);

    if (unsubscribeOrders) unsubscribeOrders();

    const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
    unsubscribeOrders = onSnapshot(q, async snapshot => {
      let allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      let filteredOrders = [];
      let todaySales = 0;
      let monthSales = 0;
      let totalSales = 0;
      let distributorPayMonth = 0;

      // Increment balance for new orders
      snapshot.docChanges().forEach(async change => {
        if (change.type === "added") {
          const order = change.doc.data();
          const orderId = change.doc.id;

          if (!order.balanceUpdated) {
            let spriceTotal = 0;

            for (const item of (order.items || [])) {
              const sprice = item.sprice || 0;
              const qty = item.quantity || 1;
              spriceTotal += sprice * qty;
            }

            if (spriceTotal > 0) {
              const payRef = doc(db, "payments", "sanseoul");
              await updateDoc(payRef, { balance: increment(spriceTotal) });
              await updateDoc(doc(db, "orders", orderId), { balanceUpdated: true });
            }
          }
        }
      });

      // Aggregate stats
      allOrders.forEach(order => {
        const orderDateObj = order.createdAt?.toDate ? order.createdAt.toDate() : null;
        if (!orderDateObj) return;

        const yyyyMMDD = orderDateObj.toISOString().split("T")[0];
        const yyyyMM = yyyyMMDD.slice(0, 7);

        const total = order.totalAmount || 0;
        const spriceTotal = (order.items || []).reduce((sum, i) => sum + ((i.sprice||0)*(i.quantity||1)), 0);

        if(order.status === "completed") {
          totalSales += total;
          if (yyyyMM === currentMonth) {
            monthSales += total;
            distributorPayMonth += spriceTotal;
          }
          if (yyyyMMDD === todayDate) todaySales += total;
        }
      });

      // Filter orders
      filteredOrders = allOrders.filter(order => {
        const orderDateObj = order.createdAt?.toDate ? order.createdAt.toDate() : null;
        if (!orderDateObj) return false;
        const yyyyMMDD = orderDateObj.toISOString().split("T")[0];
        const yyyyMM = yyyyMMDD.slice(0, 7);

        if (filterValue === "today" && yyyyMMDD !== todayDate) return false;
        if (filterValue === "month" && yyyyMM !== currentMonth) return false;
        if (filterValue === "completed" && order.status !== "completed") return false;
        if (filterValue === "pending" && !["pending","accepted"].includes(order.status)) return false;
        return true;
      });

      // Render
      ordersDiv.innerHTML = filteredOrders.length
        ? filteredOrders.map(order => {
            const d = order.createdAt?.toDate ? order.createdAt.toDate() : null;
            const dateStr = d ? d.toLocaleDateString() : "-";
            const timeStr = d ? d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : "-";
            const total = order.totalAmount || 0;
            return `
              <div class="order">
                <p><strong>Items:</strong> ${(order.items || []).map(i => `${i.name} x ${i.quantity||1}`).join(", ")}</p>
                <p><strong>Total:</strong> ₹${total}</p>
                <p><strong>Status:</strong> ${order.status || "-"}</p>
                <p><strong>Date:</strong> ${dateStr} <strong>Time:</strong> ${timeStr}</p>
              </div>`;
          }).join("")
        : "<p>No orders found.</p>";

      // Update UI
      orderCountEl.textContent = `Showing ${filteredOrders.length} order${filteredOrders.length!==1?"s":""}`;
      todaySalesEl.textContent = `Today's Sales: ₹${todaySales}`;
      monthSalesEl.textContent = `This Month's Sales: ₹${monthSales}`;
      totalSalesEl.textContent = `Total Sales: ₹${totalSales}`;
      distributorPayEl.textContent = `Sanseoul Payment (Month): ₹${distributorPayMonth}`;

      // Fetch balance
      const paySnap = await getDoc(doc(db, "payments", "sanseoul"));
      const balanceVal = paySnap.exists() ? (paySnap.data().balance || 0) : 0;
      balanceBoxEl.textContent = `Balance: ₹${balanceVal}`;

      await setDoc(doc(db, "payments", "sanseoul"), {
        todaySales, monthSales, totalSales,
        distributorPayMonth,
        updatedAt: serverTimestamp()
      }, { merge: true });
    });
  }

  // Event listeners
  filterSelect.addEventListener("change", () => { highlightStatBox(null); loadOrders(); });
  todaySalesEl.addEventListener("click", () => { filterSelect.value="today"; highlightStatBox(todaySalesEl); loadOrders(); });
  monthSalesEl.addEventListener("click", () => { filterSelect.value="month"; highlightStatBox(monthSalesEl); loadOrders(); });
  totalSalesEl.addEventListener("click", () => { filterSelect.value="all"; highlightStatBox(totalSalesEl); loadOrders(); });
  distributorPayEl.addEventListener("click", () => { filterSelect.value="completed"; highlightStatBox(distributorPayEl); loadOrders(); });

  document.getElementById("logoutBtn").addEventListener("click", async () => {
    const currentPage = encodeURIComponent(window.location.pathname);
    await signOut(auth);
    window.location.href = `login.html?redirect=${currentPage}`;
  });

  document.getElementById("navToggle").addEventListener("click", () =>
    document.getElementById("navLinks").classList.toggle("show")
  );

  loadOrders();
  </script>
  <footer class="footer">
  <p>
    Developed by 
    <a href="https://unrealsolutions.pages.dev" target="_blank" rel="noopener noreferrer">UnrealSolutions</a> 
    | Contact: <a href="mailto:info.unrealsolutions@gmail.com">info.unrealsolutions@gmail.com</a> | +91-7507374446 | +91-9529102559
  </p>
</footer>
</body>
</html>
